name: .NET CD

# Добавляем конкурентность для предотвращения параллельных запусков
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_run:
    workflows: [".NET CI"]
    branches: [main, master]
    types:
      - completed
  workflow_dispatch:
    inputs:
      manual_trigger:
        description: 'Ручной запуск деплоя'
        required: false
        default: 'yes'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
    
    - name: Restore dependencies
      run: dotnet restore API/apartment-meters.sln
    
    - name: Build
      run: dotnet build API/apartment-meters.sln --no-restore
      
    - name: Publish
      run: dotnet publish API/apartment-meters.API/apartment-meters.API.csproj -c Release -o ./publish
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Build frontend
      working-directory: UI/apartment-meters.web
      run: |
        npm ci
        npm run build
      
    - name: Create deployment package
      run: |
        mkdir -p deployment
        cp -r publish/* deployment/api/
        cp -r UI/apartment-meters.web/.next deployment/ui
        cp -r UI/apartment-meters.web/public deployment/ui/public
        cp docker-compose.yml deployment/
        # Проверяем наличие Dockerfile перед копированием
        if [ -f "API/apartment-meters.API/Dockerfile" ]; then
          cp API/apartment-meters.API/Dockerfile deployment/api/
        fi
        if [ -f "UI/apartment-meters.web/Dockerfile" ]; then
          cp UI/apartment-meters.web/Dockerfile deployment/ui/
        fi
        tar -czf deploy.tar.gz -C deployment .
    
    - name: Install SSH key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
    
    - name: Test SSH connection
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: ssh -v $SERVER_USER@$SERVER_IP "echo 'SSH connection successful'"
    
    - name: Deploy to server
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        scp deploy.tar.gz $SERVER_USER@$SERVER_IP:$DEPLOY_PATH/
        ssh $SERVER_USER@$SERVER_IP "cd $DEPLOY_PATH && \
        mkdir -p backup && \
        tar -czf backup/backup-$(date +%Y%m%d-%H%M%S).tar.gz api ui docker-compose.yml && \
        rm -rf api ui && \
        tar -xzf deploy.tar.gz && \
        rm deploy.tar.gz && \
        docker-compose up -d --build"
    
    - name: Verify deployment
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        ssh $SERVER_USER@$SERVER_IP "docker ps | grep apartment_meters"
        echo "✅ Деплой успешно выполнен на сервер" 