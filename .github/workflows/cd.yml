name: .NET CD

# Настраиваем конкурентность более строго
concurrency:
  group: "deploy"
  cancel-in-progress: true

on:
  workflow_run:
    workflows: [".NET CI"]
    branches: [main, master]
    types:
      - completed
  workflow_dispatch:
    inputs:
      manual_trigger:
        description: 'Ручной запуск деплоя'
        required: false
        default: 'yes'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Check workspace
      run: |
        echo "Проверка рабочей директории:"
        pwd
        ls -la
        echo "Проверка UI директории:"
        ls -la UI/ || echo "UI директория не найдена"
        echo "Проверка API директории:"
        ls -la API/ || echo "API директория не найдена"
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
    
    - name: Restore dependencies
      run: dotnet restore API/apartment-meters.sln
    
    - name: Build
      run: dotnet build API/apartment-meters.sln --no-restore
      
    - name: Publish
      run: dotnet publish API/apartment-meters.API/apartment-meters.API.csproj -c Release -o ./publish
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Build frontend
      working-directory: UI/apartment-meters.web
      run: |
        npm ci
        npm run build
        echo "Содержимое директории после сборки:"
        ls -la
        ls -la .next || echo ".next директория не найдена"
      
    - name: Create deployment package
      run: |
        # Очищаем и создаем директорию для деплоя
        rm -rf deployment
        mkdir -p deployment
        
        # Копируем директории API, UI и файл docker-compose.yml
        echo "Копирование API директории..."
        mkdir -p deployment/API/apartment-meters.API
        cp -r publish/* deployment/API/apartment-meters.API/
        
        echo "Копирование UI директории..."
        mkdir -p deployment/UI/apartment-meters.web
        
        if [ -d "UI/apartment-meters.web/.next" ]; then
          cp -r UI/apartment-meters.web/.next deployment/UI/apartment-meters.web/
        else
          echo "ВНИМАНИЕ: Директория .next не найдена!"
        fi
        
        if [ -d "UI/apartment-meters.web/public" ]; then
          cp -r UI/apartment-meters.web/public deployment/UI/apartment-meters.web/
        else
          echo "ВНИМАНИЕ: Директория public не найдена!"
        fi
        
        # Копируем Dockerfile
        if [ -f "API/apartment-meters.API/Dockerfile" ]; then
          cp API/apartment-meters.API/Dockerfile deployment/API/apartment-meters.API/
        else
          echo "ВНИМАНИЕ: API Dockerfile не найден!"
        fi
        
        if [ -f "UI/apartment-meters.web/Dockerfile" ]; then
          cp UI/apartment-meters.web/Dockerfile deployment/UI/apartment-meters.web/
        else
          echo "ВНИМАНИЕ: UI Dockerfile не найден!"
        fi
        
        # Копируем docker-compose.yml
        cp docker-compose.yml deployment/
        
        # Проверяем созданную структуру
        echo "Структура деплой-пакета:"
        find deployment -type d | sort
        
        # Создаем архив
        tar -czvf deploy.tar.gz -C deployment .
        
        # Проверяем содержимое архива
        echo "Содержимое архива:"
        tar -tvf deploy.tar.gz
    
    - name: Install SSH key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
    
    - name: Test SSH connection
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: ssh -v $SERVER_USER@$SERVER_IP "echo 'SSH connection successful'"
    
    - name: Deploy to server
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        # Отправка архива на сервер
        scp deploy.tar.gz $SERVER_USER@$SERVER_IP:$DEPLOY_PATH/
        
        # Выполнение деплоя на сервере
        ssh $SERVER_USER@$SERVER_IP "cd $DEPLOY_PATH && \
        echo '1. Создание резервной копии...' && \
        mkdir -p backup && \
        tar -czf backup/backup-$(date +%Y%m%d-%H%M%S).tar.gz API UI docker-compose.yml || echo 'Резервная копия не создана' && \
        echo '2. Удаление старых файлов...' && \
        rm -rf API UI || echo 'Старые директории не найдены' && \
        echo '3. Распаковка новых файлов...' && \
        tar -xzf deploy.tar.gz && \
        rm deploy.tar.gz && \
        echo '4. Запуск контейнеров...' && \
        docker-compose up -d --build"
    
    - name: Verify deployment
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        ssh $SERVER_USER@$SERVER_IP "echo 'Статус контейнеров:' && docker ps | grep apartment_meters"
        echo "✅ Деплой завершен" 